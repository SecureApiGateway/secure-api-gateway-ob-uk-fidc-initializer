{
  "name" : "Open Banking Dynamic Policy",
  "context" : "POLICY_CONDITION",
  "description" : "Open Banking Dynamic Policy",
  "language" : "JAVASCRIPT",
  "script" : "ZnVuY3Rpb24gZ2V0SWRtQ2xpZW50RGV0YWlscygpIHsKICByZXR1cm4geyAKICAgICJpZCI6ICJwb2xpY3ktY2xpZW50IiwKICAgICJzZWNyZXQiOiAicGFzc3dvcmQiLAogICAgImVuZHBvaW50IjogImh0dHA6Ly9hbS9hbS9vYXV0aDIvcmVhbG1zL3Jvb3QvcmVhbG1zL2FscGhhL2FjY2Vzc190b2tlbiIsCiAgICAic2NvcGUiOiAiZnI6aWRtOioiLAogICAgImlkbUFkbWluVXNlcm5hbWUiOiAic2VydmljZV9hY2NvdW50LnBvbGljeSIsCiAgICAiaWRtQWRtaW5QYXNzd29yZCI6ICIwcGVuQmFua2luZyEiCiAgfQp9CgpTVEFUVVNfQVVUSE9SSVNFRCA9ICJBdXRob3Jpc2VkIgoKCgpsb2dnZXIubWVzc2FnZSgiT0JfUG9saWN5IHN0YXJ0aW5nIikKCgoKZnVuY3Rpb24gcGFyc2VSZXNvdXJjZVVyaSgpIHsKICB2YXIgZWxlbWVudHMgPSByZXNvdXJjZVVSSS5zcGxpdCgiLyIpOwogIHJldHVybiB7CiAgICAiYXBpIjogZWxlbWVudHNbNl0sCiAgICAiYWNjb3VudCI6IChlbGVtZW50cy5sZW5ndGggPiA3KSA/IGVsZW1lbnRzWzddIDogbnVsbCwKICAgICJkYXRhIiA6IChlbGVtZW50cy5sZW5ndGggPiA4KSA/IGVsZW1lbnRzWzhdIDogbnVsbAogIH0KfQoKCnZhciBwPSI9IjsKdmFyIHRhYj0iQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLyI7CgpmdW5jdGlvbiBiYXNlNjRlbmNvZGUoYmEpIHsKCQl2YXIgcz1bXSwgbD1iYS5sZW5ndGg7CgkJdmFyIHJtPWwlMzsKCQl2YXIgeD1sLXJtOwoJCWZvciAodmFyIGk9MDsgaTx4Oyl7CgkJCXZhciB0PWJhW2krK108PDE2fGJhW2krK108PDh8YmFbaSsrXTsKCQkJcy5wdXNoKHRhYi5jaGFyQXQoKHQ+Pj4xOCkmMHgzZikpOwoJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjEyKSYweDNmKSk7CgkJCXMucHVzaCh0YWIuY2hhckF0KCh0Pj4+NikmMHgzZikpOwoJCQlzLnB1c2godGFiLmNoYXJBdCh0JjB4M2YpKTsKCQl9CgkJLy8JZGVhbCB3aXRoIHRyYWlsZXJzLCBiYXNlZCBvbiBwYXRjaCBmcm9tIFBldGVyIFdvb2QuCgkJc3dpdGNoKHJtKXsKCQkJY2FzZSAyOnsKCQkJCXZhciB0PWJhW2krK108PDE2fGJhW2krK108PDg7CgkJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjE4KSYweDNmKSk7CgkJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjEyKSYweDNmKSk7CgkJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjYpJjB4M2YpKTsKCQkJCXMucHVzaChwKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgMTp7CgkJCQl2YXIgdD1iYVtpKytdPDwxNjsKCQkJCXMucHVzaCh0YWIuY2hhckF0KCh0Pj4+MTgpJjB4M2YpKTsKCQkJCXMucHVzaCh0YWIuY2hhckF0KCh0Pj4+MTIpJjB4M2YpKTsKCQkJCXMucHVzaChwKTsKCQkJCXMucHVzaChwKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiBzLmpvaW4oIiIpOwkvLwlzdHJpbmcKfQoKZnVuY3Rpb24gYmFzZTY0ZGVjb2RlKHN0cikgewoJCXZhciBzPXN0ci5zcGxpdCgiIiksIG91dD1bXTsKCQl2YXIgbD1zLmxlbmd0aDsKCQl3aGlsZShzWy0tbF09PXApeyB9CS8vCXN0cmlwIG9mZiB0cmFpbGluZyBwYWRkaW5nCgkJZm9yICh2YXIgaT0wOyBpPGw7KXsKCQkJdmFyIHQ9dGFiLmluZGV4T2Yoc1tpKytdKTw8MTg7CgkJCWlmKGk8PWwpeyB0fD10YWIuaW5kZXhPZihzW2krK10pPDwxMiB9OwoJCQlpZihpPD1sKXsgdHw9dGFiLmluZGV4T2Yoc1tpKytdKTw8NiB9OwoJCQlpZihpPD1sKXsgdHw9dGFiLmluZGV4T2Yoc1tpKytdKSB9OwoJCQlvdXQucHVzaCgodD4+PjE2KSYweGZmKTsKCQkJb3V0LnB1c2goKHQ+Pj44KSYweGZmKTsKCQkJb3V0LnB1c2godCYweGZmKTsKCQl9CgkJLy8Jc3RyaXAgb2ZmIGFueSBudWxsIGJ5dGVzCgkJd2hpbGUob3V0W291dC5sZW5ndGgtMV09PTApeyBvdXQucG9wKCk7IH0KCQlyZXR1cm4gb3V0OwkvLwlieXRlW10KfQoKZnVuY3Rpb24gc3RyaW5nRnJvbUFycmF5KGRhdGEpIHsKICAgIHZhciBjb3VudCA9IGRhdGEubGVuZ3RoOwogICAgdmFyIHN0ciA9ICIiOwogICAgCiAgICBmb3IodmFyIGluZGV4ID0gMDsgaW5kZXggPCBjb3VudDsgaW5kZXggKz0gMSkKICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoZGF0YVtpbmRleF0pOwogICAgCiAgICByZXR1cm4gc3RyOwp9CgpmdW5jdGlvbiBsb2dSZXNwb25zZShyZXNwb25zZSkgewogICAgbG9nZ2VyLndhcm5pbmcoIk9CX1BvbGljeSBVc2VyIFJFU1QgQ2FsbC4gU3RhdHVzOiAiICsgcmVzcG9uc2UuZ2V0U3RhdHVzKCkgKyAiLCBCb2R5OiAiICsgcmVzcG9uc2UuZ2V0RW50aXR5KCkuZ2V0U3RyaW5nKCkpOwp9CgoKCmZ1bmN0aW9uIGdldElkbUFjY2Vzc1Rva2VuKCkgewoKICAgIHZhciBjbGllbnRJbmZvID0gZ2V0SWRtQ2xpZW50RGV0YWlscygpOwogICAgdmFyIHJlcXVlc3QgPSBuZXcgb3JnLmZvcmdlcm9jay5odHRwLnByb3RvY29sLlJlcXVlc3QoKTsKICAgIHJlcXVlc3Quc2V0VXJpKGNsaWVudEluZm8uZW5kcG9pbnQpOwogIAlyZXF1ZXN0LnNldE1ldGhvZCgiUE9TVCIpOwogICAgcmVxdWVzdC5nZXRIZWFkZXJzKCkuYWRkKCJDb250ZW50LVR5cGUiLCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKTsKICAgIHZhciBmb3JtdmFycyA9ICJncmFudF90eXBlPXBhc3N3b3JkIiArCiAgICAgICAgIiZjbGllbnRfaWQ9IiArIGNsaWVudEluZm8uaWQgKwogICAgICAgICImY2xpZW50X3NlY3JldD0iICsgY2xpZW50SW5mby5zZWNyZXQgKwogICAgICAgICImc2NvcGU9IiArIGNsaWVudEluZm8uc2NvcGUgKwogICAgICAgICImdXNlcm5hbWU9IiArIGNsaWVudEluZm8uaWRtQWRtaW5Vc2VybmFtZSArCiAgICAgICAgIiZwYXNzd29yZD0iICsgY2xpZW50SW5mby5pZG1BZG1pblBhc3N3b3JkOwogICAgcmVxdWVzdC5zZXRFbnRpdHkoZm9ybXZhcnMpOwoKICAgIHZhciByZXNwb25zZSA9IGh0dHBDbGllbnQuc2VuZChyZXF1ZXN0KS5nZXQoKTsKCiAgCiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIG9hdXRoMnJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZS5nZXRFbnRpdHkoKS5nZXRTdHJpbmcoKSk7CgogICAgdmFyIGFjY2Vzc1Rva2VuID0gb2F1dGgycmVzcG9uc2UuYWNjZXNzX3Rva2VuCiAgICBsb2dnZXIud2FybmluZygiT0JfUG9saWN5IEdvdCBhY2VzcyB0b2tlbiAiICsgYWNjZXNzVG9rZW4pOwogICAgcmV0dXJuIGFjY2Vzc1Rva2VuCn0KCmZ1bmN0aW9uIGdldEludGVudChpbnRlbnRJZCxhcGkpIHsKICB2YXIgb2JqID0gbnVsbAogIAogIHN3aXRjaCAoYXBpKSB7CiAgICBjYXNlICJhY2NvdW50cyI6IAogICAgICBvYmogPSAiYWNjb3VudEFjY2Vzc0ludGVudCIKICAgICAgYnJlYWs7CiAgICBjYXNlICJkb21lc3RpYy1wYXltZW50cyI6CiAgICAgIG9iaiA9ICJkb21lc3RpY1BheW1lbnRJbnRlbnQiCiAgICAgIGJyZWFrOwogIH0KICAgCiAgdmFyIGFjY2Vzc1Rva2VuID0gZ2V0SWRtQWNjZXNzVG9rZW4oKTsKICB2YXIgcmVxdWVzdCA9IG5ldyBvcmcuZm9yZ2Vyb2NrLmh0dHAucHJvdG9jb2wuUmVxdWVzdCgpOwogIHZhciB1cmkgPSAiaHR0cDovL2lkbS9vcGVuaWRtL21hbmFnZWQvIiArIG9iaiArICIvIiArIGludGVudElkCiAgbG9nZ2VyLm1lc3NhZ2UoIk9CX1BvbGljeSBJRE0gZmV0Y2ggIiArIHVyaSkKICAKICByZXF1ZXN0LnNldE1ldGhvZCgnR0VUJyk7CiAgcmVxdWVzdC5zZXRVcmkodXJpKQogIHJlcXVlc3QuZ2V0SGVhZGVycygpLmFkZCgiQXV0aG9yaXphdGlvbiIsIkJlYXJlciAiICsgYWNjZXNzVG9rZW4pOwoKICAKICB2YXIgcmVzcG9uc2UgPSBodHRwQ2xpZW50LnNlbmQocmVxdWVzdCkuZ2V0KCk7CiAgbG9nUmVzcG9uc2UocmVzcG9uc2UpOwoKICB2YXIgaW50ZW50ID0gSlNPTi5wYXJzZShyZXNwb25zZS5nZXRFbnRpdHkoKS5nZXRTdHJpbmcoKSk7CiAgcmV0dXJuIGludGVudAp9CgpmdW5jdGlvbiBkYXRhQXV0aG9yaXNlZChwZXJtaXNzaW9ucyxkYXRhUmVxdWVzdCkgewogIHN3aXRjaCAoZGF0YVJlcXVlc3QpIHsKICAgIGNhc2UgImJhbGFuY2VzIjoKICAgICAgYXV0aG9yaXNlZCA9IChwZXJtaXNzaW9ucy5pbmRleE9mKCJSZWFkQmFsYW5jZXMiKSA+IC0xKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJ0cmFuc2FjdGlvbnMiOgogICAgICBhdXRob3Jpc2VkID0gKHBlcm1pc3Npb25zLmluZGV4T2YoIlJlYWRUcmFuc2FjdGlvbnNEZXRhaWwiKSA+IC0xKTsKICAgICAgYnJlYWsKICAgIGRlZmF1bHQ6CiAgICAgIGF1dGhvcmlzZWQgPSBmYWxzZQogICAgICAKICB9CiAgCiAgcmV0dXJuIGF1dGhvcmlzZWQKfQoKZnVuY3Rpb24gaW5pdGlhdGlvbk1hdGNoKGluaXRpYXRpb25SZXF1ZXN0LGluaXRpYXRpb24pIHsKICAKICAvLyBUT0RPOiBkbyBjb21wYXJpc29uIGF0IG9iamVjdCBsZXZlbCwgbGlrZSBKU09OQXNzZXJ0KCkKICAKICB2YXIgaW5pdGlhdGlvblJlcXVlc3RPYmogPSBKU09OLnBhcnNlKHN0cmluZ0Zyb21BcnJheShiYXNlNjRkZWNvZGUoaW5pdGlhdGlvblJlcXVlc3QpKSkgCiAgCiAgCiAgdmFyIG1hdGNoID0gCiAgICAgIChpbml0aWF0aW9uUmVxdWVzdE9iai5JbnN0cnVjdGlvbklkZW50aWZpY2F0aW9uID09IGluaXRpYXRpb24uSW5zdHJ1Y3Rpb25JZGVudGlmaWNhdGlvbikgJiYKICAgICAgKGluaXRpYXRpb25SZXF1ZXN0T2JqLkVuZFRvRW5kSWRlbnRpZmljYXRpb24gPT0gaW5pdGlhdGlvbi5FbmRUb0VuZElkZW50aWZpY2F0aW9uKSAmJgogICAgICAoaW5pdGlhdGlvblJlcXVlc3RPYmouSW5zdHJ1Y3RlZEFtb3VudC5BbW91bnQgPT0gaW5pdGlhdGlvbi5JbnN0cnVjdGVkQW1vdW50LkFtb3VudCkgJiYKICAgICAgKGluaXRpYXRpb25SZXF1ZXN0T2JqLkluc3RydWN0ZWRBbW91bnQuQ3VycmVuY3kgPT0gaW5pdGlhdGlvbi5JbnN0cnVjdGVkQW1vdW50LkN1cnJlbmN5KSAmJgogICAgICAoaW5pdGlhdGlvblJlcXVlc3RPYmouQ3JlZGl0b3JBY2NvdW50LlNjaGVtZU5hbWUgPT0gaW5pdGlhdGlvbi5DcmVkaXRvckFjY291bnQuU2NoZW1lTmFtZSkgJiYKICAgICAgKGluaXRpYXRpb25SZXF1ZXN0T2JqLkNyZWRpdG9yQWNjb3VudC5OYW1lID09IGluaXRpYXRpb24uQ3JlZGl0b3JBY2NvdW50Lk5hbWUpICYmCiAgICAgIChpbml0aWF0aW9uUmVxdWVzdE9iai5DcmVkaXRvckFjY291bnQuU2Vjb25kYXJ5SWRlbnRpZmljYXRpb24gPT0gaW5pdGlhdGlvbi5DcmVkaXRvckFjY291bnQuU2Vjb25kYXJ5SWRlbnRpZmljYXRpb24pICYmCiAgICAgIChpbml0aWF0aW9uUmVxdWVzdE9iai5SZW1pdHRhbmNlSW5mb3JtYXRpb24uUmVmZXJlbmNlID09IGluaXRpYXRpb24uUmVtaXR0YW5jZUluZm9ybWF0aW9uLlJlZmVyZW5jZSkgJiYKICAgICAgKGluaXRpYXRpb25SZXF1ZXN0T2JqLlJlbWl0dGFuY2VJbmZvcm1hdGlvbi5VbnN0cnVjdHVyZWQgPT0gaW5pdGlhdGlvbi5SZW1pdHRhbmNlSW5mb3JtYXRpb24uVW5zdHJ1Y3R1cmVkKQogICAgICAKICAgICAgCiAgaWYgKCFtYXRjaCkgewogICAgbG9nZ2VyLndhcm5pbmcoIk1pc21hdGNoIGJldHdlZW4gcmVxdWVzdCBbIiArIEpTT04uc3RyaW5naWZ5KGluaXRpYXRpb25SZXF1ZXN0T2JqKSArICJdIGFuZCBjb25zZW50IFsiICsgSlNPTi5zdHJpbmdpZnkoaW5pdGlhdGlvbikgKyAiXSIpOwogIH0KICAgICAgICAgICAgICAgICAgIAogIHJldHVybiBtYXRjaAp9Cgp2YXIgaW50ZW50SWQgPSBlbnZpcm9ubWVudC5nZXQoImludGVudF9pZCIpLml0ZXJhdG9yKCkubmV4dCgpOwoKdmFyIGFwaVJlcXVlc3QgPSBwYXJzZVJlc291cmNlVXJpKCkKCmxvZ2dlci53YXJuaW5nKCJPQl9Qb2xpY3kgcmVxICIgKyBhcGlSZXF1ZXN0LmFwaSArICI6IiArIGFwaVJlcXVlc3QuYWNjb3VudCArICI6IiArIGFwaVJlcXVlc3QuZGF0YSk7CiAgICAgICAgICAgICAgIAp2YXIgaW50ZW50ID0gZ2V0SW50ZW50KGludGVudElkLGFwaVJlcXVlc3QuYXBpKTsKCmlmIChhcGlSZXF1ZXN0LmFwaSA9PSAiYWNjb3VudHMiKSB7CgogIHZhciBzdGF0dXMgPSBpbnRlbnQuRGF0YS5TdGF0dXMKICB2YXIgcGVybWlzc2lvbnMgPSBpbnRlbnQuRGF0YS5QZXJtaXNzaW9ucwogIHZhciBhY2NvdW50cyA9IGludGVudC5hY2NvdW50cwoKICBpZiAoc3RhdHVzICE9IFNUQVRVU19BVVRIT1JJU0VEKSB7CiAgICBsb2dnZXIud2FybmluZygiUmVqZWN0aW5nIHJlcXVlc3QgLSBzdGF0dXMgWyIgKyBzdGF0dXMgKyAiXSIpCiAgICBhdXRob3JpemVkID0gZmFsc2UKICAgIAogIH0KICBlbHNlIGlmIChhcGlSZXF1ZXN0LmFjY291bnQgPT0gbnVsbCkgewogICAgbG9nZ2VyLm1lc3NhZ2UoIk9CX1BPTElDWSBhY2NvdW50cyAiICsgYWNjb3VudHMpOwogICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiZ3JhbnRlZEFjY291bnRzIixhY2NvdW50cyk7CiAgICByZXNwb25zZUF0dHJpYnV0ZXMucHV0KCJncmFudGVkUGVybWlzc2lvbnMiLHBlcm1pc3Npb25zKTsKICAgIGF1dGhvcml6ZWQgPSB0cnVlCiAgfQogIGVsc2UgaWYgKGFwaVJlcXVlc3QuZGF0YSA9PSBudWxsKSB7CiAgICBsb2dnZXIubWVzc2FnZSgiT0JfUE9MSUNZIGFjY291bnQgaW5mbyBmb3IgIiArIGFwaVJlcXVlc3QuYWNjb3VudCk7CiAgICAvLyBSUyBzZXJ2ZXIgZXhwZWN0cyBncmFudGVkIGFjY291bnRzIGFuZCBwZXJtaXNzaW9ucyBldmVuIHRob3VnaCB3ZSdyZSBjaGVja2luZyBhcyB3ZWxsCiAgICByZXNwb25zZUF0dHJpYnV0ZXMucHV0KCJncmFudGVkQWNjb3VudHMiLGFjY291bnRzKTsKICAgIHJlc3BvbnNlQXR0cmlidXRlcy5wdXQoImdyYW50ZWRQZXJtaXNzaW9ucyIscGVybWlzc2lvbnMpOwogICAgYXV0aG9yaXplZCA9IChhY2NvdW50cy5pbmRleE9mKGFwaVJlcXVlc3QuYWNjb3VudCkgPiAtMSkgJiYKICAgICAgICAgICAgICAgICAocGVybWlzc2lvbnMuaW5kZXhPZigiUmVhZEFjY291bnRzRGV0YWlsIikgPiAtMSkKICB9CiAgZWxzZSB7CiAgICBsb2dnZXIubWVzc2FnZSgiT0JfUE9MSUNZIGFjY291bnQgcmVxdWVzdCBmb3IgIiArIGFwaVJlcXVlc3QuYWNjb3VudCArICI6IiArIGFwaVJlcXVlc3QuZGF0YSk7CiAgICAvLyBSUyBzZXJ2ZXIgZXhwZWN0cyBncmFudGVkIGFjY291bnRzIGFuZCBwZXJtaXNzaW9ucyBldmVuIHRob3VnaCB3ZSdyZSBjaGVja2luZyBhcyB3ZWxsCiAgICByZXNwb25zZUF0dHJpYnV0ZXMucHV0KCJncmFudGVkQWNjb3VudHMiLGFjY291bnRzKTsKICAgIHJlc3BvbnNlQXR0cmlidXRlcy5wdXQoImdyYW50ZWRQZXJtaXNzaW9ucyIscGVybWlzc2lvbnMpOwogICAgYXV0aG9yaXplZCA9IChhY2NvdW50cy5pbmRleE9mKGFwaVJlcXVlc3QuYWNjb3VudCkgPiAtMSkgJiYgCiAgICAgICAgICAgICAgICAgZGF0YUF1dGhvcmlzZWQocGVybWlzc2lvbnMsYXBpUmVxdWVzdC5kYXRhKQogIH0KICAKfQplbHNlIGlmIChhcGlSZXF1ZXN0LmFwaSA9PSAiZG9tZXN0aWMtcGF5bWVudHMiKSB7CiAgCiAgdmFyIHN0YXR1cyA9IGludGVudC5EYXRhLlN0YXR1cwogIHZhciBwZXJtaXNzaW9ucyA9IGludGVudC5EYXRhLlBlcm1pc3Npb25zCiAgdmFyIGFjY291bnQgPSBpbnRlbnQuYWNjb3VudAoKICBpZiAoc3RhdHVzICE9IFNUQVRVU19BVVRIT1JJU0VEKSB7CiAgICBsb2dnZXIud2FybmluZygiUmVqZWN0aW5nIHJlcXVlc3QgLSBzdGF0dXMgWyIgKyBzdGF0dXMgKyAiXSIpCiAgICBhdXRob3JpemVkID0gZmFsc2UKICB9CiAgZWxzZSB7CiAgICBhdXRob3JpemVkID0gaW5pdGlhdGlvbk1hdGNoKGVudmlyb25tZW50LmdldCgiaW5pdGlhdGlvbiIpLml0ZXJhdG9yKCkubmV4dCgpLGludGVudC5EYXRhLkluaXRpYXRpb24pCiAgfQogIAp9CmVsc2UgewogIGF1dGhvcml6ZWQgPSBmYWxzZQp9"
}
